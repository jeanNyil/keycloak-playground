FROM registry.access.redhat.com/ubi9/nodejs-22:1-75

# Labels for OpenShift and container metadata
LABEL name="oidc-playground" \
      version="1.0" \
      description="OpenID Connect Playground application with OpenTelemetry tracing" \
      io.k8s.display-name="OIDC Playground" \
      io.k8s.description="A playground application for learning OpenID Connect flows" \
      io.openshift.tags="nodejs,oidc,keycloak,opentelemetry" \
      io.openshift.expose-services="8000:http"

# Application environment variables
ENV KC_URL=http://localhost:8080/ \
    SERVICE_URL=http://localhost:3000/secured \
    INPUT_ISSUER=http://localhost:8080/realms/demo \
    NODE_ENV=production \
    NPM_RUN=start

# OpenTelemetry environment variables
ENV OTEL_SERVICE_NAME=oidc-playground \
    OTEL_SERVICE_VERSION=1.0.0 \
    OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317 \
    OTEL_LOG_LEVEL=info

# Set working directory
WORKDIR /opt/app-root/src

# Copy package files and install dependencies
COPY --chown=1001:0 package*.json ./
RUN npm ci --only=production && \
    npm cache clean --force

# Copy application files with proper ownership
COPY --chown=1001:0 app.js tracing.js client.js index.html styles.css ./

# Set proper permissions for OpenShift (arbitrary user ID support)
RUN chmod -R g=u /opt/app-root/src

# Use non-root user (required by OpenShift)
USER 1001

EXPOSE 8000

CMD [ "npm", "start" ]

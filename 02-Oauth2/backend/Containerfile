FROM registry.access.redhat.com/ubi10/nodejs-22:10.1

# Labels for OpenShift and container metadata
LABEL name="oauth-playground-backend" \
      version="1.0" \
      description="OAuth 2.0 Playground backend service with OpenTelemetry tracing" \
      io.k8s.display-name="OAuth Playground Backend" \
      io.k8s.description="A backend service for the OAuth 2.0 Playground application" \
      io.openshift.tags="nodejs,oauth,keycloak,opentelemetry" \
      io.openshift.expose-services="3000:http"

# Application environment variables
ENV NODE_ENV=production \
    NPM_RUN=start

# OpenTelemetry environment variables
ENV OTEL_SERVICE_NAME=oauth-playground-backend \
    OTEL_SERVICE_VERSION=1.0.0 \
    OTEL_EXPORTER_OTLP_ENDPOINT=http://localhost:4317 \
    OTEL_LOG_LEVEL=info

# Set working directory
WORKDIR /opt/app-root/src

# Copy package files and install dependencies
COPY --chown=1001:0 package*.json ./
RUN npm install --omit=dev && \
    npm cache clean --force

# Copy application files with proper ownership
COPY --chown=1001:0 app.js tracing.js keycloak.json ./

# Set proper permissions for OpenShift (arbitrary user ID support)
RUN chmod -R g=u /opt/app-root/src

# Use non-root user (required by OpenShift)
USER 1001

EXPOSE 3000

CMD [ "npm", "start" ]
